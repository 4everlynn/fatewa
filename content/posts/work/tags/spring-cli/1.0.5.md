---
title: "Spring Cli 1.0.5 RELEASE Features"
date: 2021-11-22T13:00:10+08:00
tags: ["Spring cli"]
categories: ["java"]
draft: false
---

<div style="text-align: center;display: flex;flex-direction: column;justify-content:center;align-items:center;margin-bottom: 100px">
     <h1 style="font-weight: 300;text-shadow: 0 0 1px black;">Fatewa <span style="color: #faca30">Spring Cli Release log</span></h1>
     <h3 style="font-weight: 400;font-size: 18px;">Easy to build <b>Stronger</b><span style="margin-left: 8px;border: 1px solid black;padding: 2px 10px;background: #00b583;color: white;font-weight: 300;border-radius: 6px">restful API</span></h3>
     <span style="color: gray;font-size: 13px">
<focus-tag link>
Now at version 1.0.5
</focus-tag>
</span>
</div>


### Features

- [Protocol Exception](#Protocol-Exception)
- [Genius Hooks](#Genius-Hooks)
- [Data Scopes ğŸ”¥](#Data-Scopes)

#### Protocol Exception

æˆ‘ä»¬å·²ç»çŸ¥é“åœ¨ Spring Cli çš„é¡¹ç›®ä¸­ï¼Œé€šè¿‡ `Assert` å¯ä»¥è¿”å›é¢„æœŸçš„å¼‚å¸¸ Responseï¼Œ
ä½†å®ƒçš„å±€é™ä¹‹å¤„åœ¨äºï¼Œæ— æ³•è°ƒæ•´ `Http Status Code`, äºæ˜¯ä¸ºäº†è§£å†³æ­¤ç±»é—®é¢˜ï¼Œåœ¨æœ€æ–°(v1.0.5)
ç‰ˆæœ¬ä¸­ï¼Œè®¾è®¡äº† `ProtocolException`, ä¸€èµ·æ¥çœ‹çœ‹å§ã€‚

```java
// æ¨¡æ‹Ÿä¸€ä¸ªæ£€æŸ¥è®¢å•çš„æ–¹æ³•
public void checkOrder () {

    // ç”¨æˆ·æœªæˆæƒ
    if (!isAuth()) {
        // è¿”å›æ—¶çš„ Http Status ä¸º 401
        throw new ProtocolException(
            ResponseCode.NO_LOGIN_ERROR, "ç”¨æˆ·æœªç™»å½•"
        );
    }
    
    // ... ä¸šåŠ¡ä»£ç 
}
```

ResponseCode ä¸ºæšä¸¾ç±»å‹ï¼Œå¯åœ¨
<focus-tag link>
&lt;groups&gt;.kernel.constants.ResponseCode
</focus-tag>
ä¸­è¿›è¡Œè‡ªå®šä¹‰æ‰©å±•
é»˜è®¤æƒ…å†µä¸‹ï¼Œå…¶ç»“æ„ä¸º

```java
public enum ResponseCode {

    /**
     * å‚æ•°è¯´æ˜
     */
    SUCCESS("E0001", "è¯·æ±‚æˆåŠŸ", HttpStatus.OK),
    ERROR_SERVICE("E1001", "å¹³å°æœåŠ¡å¼‚å¸¸",
        HttpStatus.INTERNAL_SERVER_ERROR),
        
    ERROR_DB("E1002", "æœåŠ¡å™¨æ•°æ®åº“å¼‚å¸¸", 
        HttpStatus.INTERNAL_SERVER_ERROR),
        
    UNIQUE_KEY("E1003", "å”¯ä¸€å€¼é‡å¤å½•å…¥",
        HttpStatus.INTERNAL_SERVER_ERROR),
        
    TRANSFORM_ERROR("E1004", "ç±»å‹è½¬æ¢é”™è¯¯", 
        HttpStatus.INTERNAL_SERVER_ERROR),
        
    ERROR_QUERY("E2001", "è¯·æ±‚å‚æ•°å¼‚å¸¸ï¼Œç¼ºå°‘å¿…å¡«é¡¹", 
        HttpStatus.BAD_REQUEST),
        
    ERROR_QUERY_FORMAT("E2002", "è¯·æ±‚å‚æ•°å¼‚å¸¸ï¼Œå‚æ•°æ ¼å¼ä¸åˆæ³•",
         HttpStatus.BAD_REQUEST),
         
    NO_LOGIN_ERROR("E4001", "è¯·å…ˆç™»å½•", HttpStatus.UNAUTHORIZED);

    /**
     * å€¼
     */
    public String value;
    
    /**
     * å¯¹åº”ä¿¡æ¯
     */
    public String msg;

    /**
     * å¯¹åº” Http Status
     */
    public HttpStatus status;
}
```

#### Genius Hooks

åœ¨ä»¥å¾€çš„ Spring cli ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬å·²ç»èƒ½å¤Ÿå€ŸåŠ©äº <focus-tag link> @Export </focus-tag>
æ³¨è§£æ‰€æä¾›çš„èƒ½åŠ›è¿›è¡Œ Level 2 çš„ Restful API è‡ªåŠ¨ç”Ÿæˆï¼Œå¯æ˜¯åœ¨å®é™…çš„ä¸šåŠ¡ç ”å‘ä¸­ï¼Œæˆ‘ä»¬å‘ç°ï¼Œè¿™äº›
ç”Ÿæˆçš„æ¥å£å¾€å¾€ä¸èƒ½å®Œå…¨èƒœä»»ä¸šåŠ¡éœ€æ±‚æˆ–è€…è¯´æ— æ³•è·Ÿéšä¸šåŠ¡è€Œè¿›è¡Œæ‰©å±•ï¼Œå› æ­¤æˆ‘ä»¬çš„ç”¨æˆ·è¿˜æ˜¯é€‰æ‹©è‡ªè¡Œåˆ›å»º
å¹¶é‡æ–°å®ç°æ¥å£ï¼Œè€Œè¿™ä¹Ÿå°±æ„å‘³ç€ï¼Œä¸¢å¤±äº† Spring cli ä¸­æ‰€è‡ªå¸¦çš„ validation scope (å³åŒºåˆ† Createã€Update çš„å‚æ•°æ ¡éªŒ)ï¼Œ
åœ¨è¿™æ ·çš„å‰æèƒŒæ™¯ä¸‹ï¼ŒGenius Hooks å°±è‡ªç„¶è€Œç„¶çš„å‡ºç°äº†ã€‚

æˆ‘ä»¬å°† `Genius Hooks` è´¯ç©¿è¿›äº† GeniusProxyWrapper, å®ƒçš„æµç¨‹å¦‚ä¸‹å›¾

<div style="margin-bottom: 45px;text-align: center" class="mermaid">
graph TB;
    r(Request&lt;T&gt;)
    c(Create Entity)
    u(Update Entity)
    d(Delete Entity)
    e(End)
    r --post--> hooks.beforeCreate --> c --> hooks.created --> e
    r --patch--> hooks.beforeUpdate --> u --> hooks.updated --> e
    r --delete--> hooks.beforeDelete --> d --> hooks.deleted --> e

</div>

ä½¿ç”¨æ¡ˆä¾‹

```java
@Configuration
public class KernelConfig {

    // é…ç½®ä¸º StoreInfo çš„ Hook
    @Bean
    GeniusHooks<StoreInfo> hooks () {
        return new GeniusHooks<StoreInfo>() {
        
        // æ•°æ®åˆ›å»ºå®Œæˆçš„é’©å­
        @Override
        public void created(AncestorDomain domain, boolean s) {
                // è¿”å›çš„æ˜¯çˆ¶ç±»å‹ï¼Œéœ€è¦å‘ä¸‹è½¬å‹
                final StoreInfo storeInfo = (StoreInfo) domain;
                System.out.println(storeInfo);
            }
        };
    }
    
}
```

> åœ¨é’©å­å†…æŠ›å‡ºå¼‚å¸¸å¯ä»¥ä¸­æ–­æ¥å£è¿›è¡Œ
> ä¹Ÿå¯ä»¥ç»“åˆä¸Šæ–‡ä¸­çš„ ProtocolException è¿›è¡Œ HttpStatus æ§åˆ¶


#### Data Scopes

ä½œä¸ºç°ä»£åŒ–å¼€ç®±å³ç”¨çš„åº”ç”¨æ¡†æ¶ï¼Œæ•°æ®éš”ç¦»æ˜¯ç»•ä¸å¼€çš„è¯é¢˜ï¼Œåœ¨æ­¤å‰ Spring Cli çš„ç»“æ„ä¸­ï¼Œ
ç”±äºæ¥å£çš„é«˜åº¦è‡ªåŠ¨åŒ–ï¼Œå¯¼è‡´ç”¨æˆ·å¾ˆéš¾åœ¨ä¸å»è°ƒæ•´æ ¸å¿ƒæºç çš„å‰æä¸‹å»æ§åˆ¶æ•°æ®çš„éš”ç¦»ï¼Œä½†æ˜¯ä¸å¿…æ‹…å¿ƒï¼Œ
åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œæ­¤æœºåˆ¶å·²è¢«å®ç°ã€‚

ç°æœ‰çš„æ ¸å¿ƒä»£ç ä¸­ï¼Œå·²ç»é›†æˆäº†æ­¤åŠŸèƒ½ï¼Œä½†é»˜è®¤æ˜¯æœªå¼€å¯çš„çŠ¶æ€ï¼Œéœ€è¦å‘ Spring å®¹å™¨ä¸­æ³¨å†Œä¸€ä¸ª
<focus-tag link>ScopedContext</focus-tag> ç±»æ‰å¯ä»¥å¼€å¯:

```java
@Configuration
public class KernelConfig {

    // é…ç½®æƒé™ä¸Šä¸‹æ–‡
    @Bean
    public ScopedContext context(JdbcTemplate template) {
        return new RequestScopeContext()
                // Session æœ‰æ•ˆæ€§æ ¡éªŒå™¨
                .calibrator((authorization, request) -> false)
                // JdbcTemplate ä½¿ç”¨é»˜è®¤çš„å³å¯
                .jdbcTemplate(template)
                // æƒé™å­—æ®µå¤„ç†å™¨
                .configure(chain -> chain.scope(new ScopedStore()));
    }
    
}
```

æƒé™å­—æ®µå¤„ç†å™¨
```java
    public class ScopedStore
            extends BaseScopeHandler<List<StoreInfo>> {
    
        // è·å–æ—¶ä½¿ç”¨çš„ key
        @Override
        public String key() {
            return "stores";
        }

        // æ ¹æ®éœ€è¦æ„å»ºSQLï¼Œä» æ“ä½œç¬¦ å¼€å§‹å†™å³å¯ï¼Œ
        // å­—æ®µåç§°ä¼šè¿›è¡Œè‡ªåŠ¨æ³¨å…¥
        @Override
        public SqlBuilder<List<StoreInfo>> builder() {
            return args -> Joiner.on("")
            .join(" in ", "(",
                    Strings.join(args.stream()
                    .map(StoreInfo::getId)
                    .collect(Collectors.toList()), ','),
                    ")");
        }

        // ä½¿ç”¨ JdbcTemplate è¿›è¡Œæ•°æ®åº“è®¿é—®
        @Override
        public List<StoreInfo> scopes() {
            final JdbcTemplate template = template();
            return template.query("select * from biz.store_info", 
                BeanPropertyRowMapper.newInstance(StoreInfo.class));
        }
    }
```

```java
@EqualsAndHashCode(callSuper = true)
@TableName(value = "store_info", schema = "biz")
@Data
public class StoreInfo extends AncestorDomain {
    private Long pid;

    /**
     * åœ¨å¯¹åº”çš„å®ä½“ç±»å¢åŠ æ³¨è§£
     */
    @Scoped(value = KernelConfig.ScopedStore.class, key = "id")
    @TableField(exist = false)
    private String storeId;
    
}
```
